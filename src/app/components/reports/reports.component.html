<div class="reports-container">
  <div class="reports-header">
    <div class="header-content">
      <div class="header-title">
        <button mat-icon-button class="back-button" (click)="goBack()">
          <mat-icon>arrow_back</mat-icon>
        </button>
        <div class="title-section">
          <h1>Génération de Rapports</h1>
          <p class="subtitle">Créez et gérez vos rapports d'analyse</p>
        </div>
      </div>
      <div class="header-actions">
        <button mat-stroked-button color="primary" (click)="refreshReports()" matTooltip="Actualiser">
          <mat-icon>refresh</mat-icon>
          Actualiser
        </button>
        <button mat-raised-button color="accent" (click)="exportIncidentsForAI()" [disabled]="loading">
          <mat-icon>cloud_download</mat-icon>
          Export CSV pour IA
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div class="loading-container" *ngIf="loading">
    <mat-spinner diameter="50"></mat-spinner>
    <p>Chargement des templates...</p>
  </div>

  <!-- Report Generation Form -->
  <div class="reports-content" *ngIf="!loading">
    <!-- New Report Card -->
    <div class="report-card new-report">
      <div class="card-header">
        <div class="card-title">
          <mat-icon class="title-icon">assessment</mat-icon>
          <h2>Nouveau Rapport</h2>
        </div>
      </div>

      <div class="card-content">
        <form [formGroup]="reportForm" (ngSubmit)="generateReport()">
          <!-- Report Template Selection -->
          <div class="form-section">
            <label class="form-label">Template de rapport*</label>
            <mat-form-field appearance="outline" class="full-width">
              <mat-select formControlName="templateName" (selectionChange)="onTemplateChange($event.value)">
                <mat-option *ngFor="let template of templates" [value]="template.templateName">
                  <div class="template-option">
                    <mat-icon [style.color]="getReportTypeColor(template.templateName)">
                      {{ getReportTypeIcon(template.templateName) }}
                    </mat-icon>
                    <span>{{ template.description }}</span>
                  </div>
                </mat-option>
              </mat-select>
              <mat-error *ngIf="reportForm.get('templateName')?.hasError('required')">
                Template requis
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Export Format Selection -->
          <div class="form-section">
            <label class="form-label">Format d'export*</label>
            <mat-form-field appearance="outline" class="full-width">
              <mat-select formControlName="format">
                <mat-option *ngFor="let format of exportFormats" [value]="format">
                  <div class="format-option">
                    <mat-icon [style.color]="getFormatColor(format)">
                      {{ getFormatIcon(format) }}
                    </mat-icon>
                    <span>{{ getFormatLabel(format) }}</span>
                  </div>
                </mat-option>
              </mat-select>
              <mat-error *ngIf="reportForm.get('format')?.hasError('required')">
                Format requis
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Dynamic Parameters -->
          <div formGroupName="parameters" class="parameters-section" *ngIf="selectedTemplate">
            <div class="section-header">
              <mat-icon>settings</mat-icon>
              <h3>Paramètres du rapport</h3>
            </div>

            <!-- Incident Report Parameters -->
            <div class="form-section" *ngIf="selectedTemplate?.templateName === 'incident_report'">
              <label class="form-label">ID de l'incident</label>
              <mat-form-field appearance="outline" class="full-width">
                <input matInput formControlName="incidentId" type="number" placeholder="Ex: 123">
                <mat-error *ngIf="reportForm.get('parameters.incidentId')?.hasError('required')">
                  ID de l'incident requis
                </mat-error>
              </mat-form-field>
            </div>

            <!-- SLA Report Parameters -->
            <div class="form-section" *ngIf="selectedTemplate?.templateName === 'sla_report'">
              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Type d'incident</mat-label>
                  <input matInput formControlName="incidentType" placeholder="Ex: Bug, Feature">
                  <mat-error *ngIf="reportForm.get('parameters.incidentType')?.hasError('required')">
                    Type d'incident requis
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Période</mat-label>
                  <mat-select formControlName="timeRange">
                    <mat-option value="LAST_WEEK">Semaine dernière</mat-option>
                    <mat-option value="LAST_MONTH">Mois dernier</mat-option>
                    <mat-option value="LAST_QUARTER">Trimestre dernier</mat-option>
                    <mat-option value="LAST_YEAR">Année dernière</mat-option>
                  </mat-select>
                  <mat-error *ngIf="reportForm.get('parameters.timeRange')?.hasError('required')">
                    Période requise
                  </mat-error>
                </mat-form-field>
              </div>
            </div>

            <!-- Performance Report Parameters -->
            <div class="form-section" *ngIf="selectedTemplate?.templateName === 'performance_report'">
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Période</mat-label>
                <mat-select formControlName="period">
                  <mat-option *ngFor="let period of reportPeriods" [value]="period">
                    {{ period }}
                  </mat-option>
                </mat-select>
                <mat-error *ngIf="reportForm.get('parameters.period')?.hasError('required')">
                  Période requise
                </mat-error>
              </mat-form-field>
            </div>

            <!-- Analytics Report Parameters -->
            <div class="form-section" *ngIf="selectedTemplate?.templateName === 'analytics_report'">
              <div class="form-row">
                <mat-form-field appearance="outline">
                  <mat-label>Date de début</mat-label>
                  <input matInput formControlName="startDate" type="date">
                  <mat-error *ngIf="reportForm.get('parameters.startDate')?.hasError('required')">
                    Date de début requise
                  </mat-error>
                </mat-form-field>

                <mat-form-field appearance="outline">
                  <mat-label>Date de fin</mat-label>
                  <input matInput formControlName="endDate" type="date">
                  <mat-error *ngIf="reportForm.get('parameters.endDate')?.hasError('required')">
                    Date de fin requise
                  </mat-error>
                </mat-form-field>
              </div>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="form-actions">
            <button mat-raised-button 
                    color="primary" 
                    type="submit" 
                    [disabled]="reportForm.invalid || generating"
                    class="action-button">
              <mat-icon>download</mat-icon>
              {{ generating ? 'Génération...' : 'Générer et télécharger' }}
            </button>

            <button mat-raised-button 
                    color="accent" 
                    type="button" 
                    (click)="generateAndOpenReport()"
                    [disabled]="reportForm.invalid || generating"
                    class="action-button">
              <mat-icon>open_in_new</mat-icon>
              {{ generating ? 'Génération...' : 'Générer et ouvrir' }}
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Report History Card -->
    <div class="report-card history-card">
      <div class="card-header">
        <div class="card-title">
          <mat-icon class="title-icon">history</mat-icon>
          <h2>Historique des Rapports</h2>
        </div>
      </div>

      <div class="card-content">
        <div class="history-list" *ngIf="reportHistory.length > 0; else emptyHistory">
          <div class="history-item" *ngFor="let report of reportHistory">
            <div class="history-info">
              <div class="history-header">
                <h4>{{ report.templateName }}</h4>
                <div class="history-status">
                  <mat-icon [style.color]="getStatusColor(report.status)">
                    {{ getStatusIcon(report.status) }}
                  </mat-icon>
                  <span>{{ report.status }}</span>
                </div>
              </div>
              
              <div class="history-details">
                <span class="format-badge" [style.background-color]="getFormatColor(report.format)">
                  <mat-icon>{{ getFormatIcon(report.format) }}</mat-icon>
                  {{ getFormatLabel(report.format) }}
                </span>
                <span class="date">{{ report.createdAt | date:'short' }}</span>
              </div>
            </div>

            <div class="history-actions">
              <button mat-icon-button 
                      (click)="downloadReport(report.id)"
                      *ngIf="report.status === 'COMPLETED'"
                      matTooltip="Télécharger"
                      class="action-icon">
                <mat-icon>download</mat-icon>
              </button>
              <button mat-icon-button 
                      (click)="cancelReport(report.id)"
                      *ngIf="report.status === 'GENERATING'"
                      matTooltip="Annuler"
                      class="action-icon">
                <mat-icon>cancel</mat-icon>
              </button>
            </div>
          </div>
        </div>

        <ng-template #emptyHistory>
          <div class="empty-history">
            <div class="empty-icon">
              <mat-icon>schedule</mat-icon>
            </div>
            <div class="empty-content">
              <h3>Aucun rapport généré</h3>
              <p>Générez votre premier rapport pour voir l'historique</p>
            </div>
          </div>
        </ng-template>
      </div>
    </div>
  </div>
</div>
