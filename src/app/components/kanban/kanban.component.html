<div class="kanban-container">
  <div class="kanban-header">
    <div class="title">
      <h2>Tableau Kanban</h2>
    </div>
    <div class="actions">
      <mat-form-field appearance="outline" class="search">
        <mat-label>Rechercher</mat-label>
        <mat-icon matPrefix>search</mat-icon>
        <input matInput placeholder="Titre, description, assigné, #ID..." [(ngModel)]="searchTerm" (ngModelChange)="onSearch($event)"/>
        <button mat-icon-button matSuffix (click)="onSearch('')" [disabled]="!searchTerm" aria-label="Effacer la recherche">
          <mat-icon>{{ searchTerm ? 'close' : 'search' }}</mat-icon>
        </button>
      </mat-form-field>
      <button mat-flat-button color="primary" (click)="createTicket()">
        <mat-icon>add</mat-icon>
        Nouvelle carte
      </button>
    </div>
  </div>

  <div class="kanban-board-wrapper" *ngIf="!loading; else loadingTemplate">
    <button class="scroll-arrow scroll-arrow-left" 
            (click)="scrollLeft()" 
            [disabled]="canScrollLeft"
            mat-icon-button>
      <mat-icon>chevron_left</mat-icon>
    </button>
    
    <div class="kanban-board" #kanbanBoard>
    <!-- Backlog -->
    <div class="kanban-column">
      <div class="column-header backlog">
        <h3>Backlog</h3>
        <span class="count">{{ getFilteredCount('backlog') }}</span>
      </div>
      <div class="column-content" 
           cdkDropList 
           id="backlog"
           [cdkDropListData]="backlog"
           [cdkDropListConnectedTo]="['ouvert', 'enCours', 'aValider', 'resolu']"
           (cdkDropListDropped)="onDrop($event)"
           (cdkDropListEntered)="onListEntered('backlog')"
           (cdkDropListExited)="onListExited('backlog')"
           [ngClass]="{ 'is-over': isOver['backlog'] }">
        <div class="ticket-card" 
             *ngFor="let incident of backlog | slice:0; let i = index" 
             [style.display]="matchesSearch(incident) ? 'block' : 'none'"
             cdkDrag>
          <div class="drag-handle" cdkDragHandle><mat-icon>drag_indicator</mat-icon></div>
          <div class="ticket-header">
            <span class="priority-badge" 
                  [style.background-color]="getPriorityColor(incident.priority)">
              {{ getPriorityLabel(incident.priority) }}
            </span>
            <span class="ticket-id">#{{ incident.id }}</span>
          </div>
          <div class="ticket-title">{{ incident.title }}</div>
          <div class="ticket-assignee-row">
            <div class="avatar" [style.background]="getAvatarColor(incident)">{{ getAssigneeInitials(incident) }}</div>
            <div class="assignee-and-date">
              <div class="assignee-name">{{ getAssigneeName(incident) }}</div>
              <div class="created-date">Créé le {{ formatDate(incident.creationDate) }}</div>
            </div>
          </div>
        </div>
        <button class="add-card" mat-stroked-button color="primary" (click)="createTicket()"><mat-icon>add</mat-icon> Ajouter</button>
      </div>
    </div>

    <!-- Ouvert -->
    <div class="kanban-column">
      <div class="column-header ouvert">
        <h3>Ouvert</h3>
        <span class="count">{{ getFilteredCount('ouvert') }}</span>
      </div>
      <div class="column-content" 
           cdkDropList 
           id="ouvert"
           [cdkDropListData]="ouvert"
           [cdkDropListConnectedTo]="['backlog', 'enCours', 'aValider', 'resolu']"
           (cdkDropListDropped)="onDrop($event)"
           (cdkDropListEntered)="onListEntered('ouvert')"
           (cdkDropListExited)="onListExited('ouvert')"
           [ngClass]="{ 'is-over': isOver['ouvert'] }">
        <div class="ticket-card" 
             *ngFor="let incident of ouvert | slice:0; let i = index" 
             [style.display]="matchesSearch(incident) ? 'block' : 'none'"
             cdkDrag>
          <div class="drag-handle" cdkDragHandle><mat-icon>drag_indicator</mat-icon></div>
          <div class="ticket-header">
            <span class="priority-badge" 
                  [style.background-color]="getPriorityColor(incident.priority)">
              {{ getPriorityLabel(incident.priority) }}
            </span>
            <span class="ticket-id">#{{ incident.id }}</span>
          </div>
          <div class="ticket-title">{{ incident.title }}</div>
          <div class="ticket-assignee-row">
            <div class="avatar" [style.background]="getAvatarColor(incident)">{{ getAssigneeInitials(incident) }}</div>
            <div class="assignee-and-date">
              <div class="assignee-name">{{ getAssigneeName(incident) }}</div>
              <div class="created-date">Créé le {{ formatDate(incident.creationDate) }}</div>
            </div>
          </div>
        </div>
        <button class="add-card" mat-stroked-button color="primary" (click)="createTicket()"><mat-icon>add</mat-icon> Ajouter</button>
      </div>
    </div>

    <!-- En cours -->
    <div class="kanban-column">
      <div class="column-header en-cours">
        <h3>En cours</h3>
        <span class="count">{{ getFilteredCount('enCours') }}</span>
      </div>
      <div class="column-content" 
           cdkDropList 
           id="enCours"
           [cdkDropListData]="enCours"
           [cdkDropListConnectedTo]="['backlog', 'ouvert', 'aValider', 'resolu']"
           (cdkDropListDropped)="onDrop($event)"
           (cdkDropListEntered)="onListEntered('enCours')"
           (cdkDropListExited)="onListExited('enCours')"
           [ngClass]="{ 'is-over': isOver['enCours'] }">
        <div class="ticket-card" 
             *ngFor="let incident of enCours | slice:0; let i = index" 
             [style.display]="matchesSearch(incident) ? 'block' : 'none'"
             cdkDrag>
          <div class="drag-handle" cdkDragHandle><mat-icon>drag_indicator</mat-icon></div>
          <div class="ticket-header">
            <span class="priority-badge" 
                  [style.background-color]="getPriorityColor(incident.priority)">
              {{ getPriorityLabel(incident.priority) }}
            </span>
            <span class="ticket-id">#{{ incident.id }}</span>
          </div>
          <div class="ticket-title">{{ incident.title }}</div>
          <div class="ticket-assignee-row">
            <div class="avatar" [style.background]="getAvatarColor(incident)">{{ getAssigneeInitials(incident) }}</div>
            <div class="assignee-and-date">
              <div class="assignee-name">{{ getAssigneeName(incident) }}</div>
              <div class="created-date">Créé le {{ formatDate(incident.creationDate) }}</div>
            </div>
          </div>
        </div>
        <button class="add-card" mat-stroked-button color="primary" (click)="createTicket()"><mat-icon>add</mat-icon> Ajouter</button>
      </div>
    </div>

    <!-- À valider -->
    <div class="kanban-column">
      <div class="column-header a-valider">
        <h3>À valider</h3>
        <span class="count">{{ getFilteredCount('aValider') }}</span>
      </div>
      <div class="column-content" 
           cdkDropList 
           id="aValider"
           [cdkDropListData]="aValider"
           [cdkDropListConnectedTo]="['backlog', 'ouvert', 'enCours', 'resolu']"
           (cdkDropListDropped)="onDrop($event)"
           (cdkDropListEntered)="onListEntered('aValider')"
           (cdkDropListExited)="onListExited('aValider')"
           [ngClass]="{ 'is-over': isOver['aValider'] }">
        <div class="ticket-card" 
             *ngFor="let incident of aValider | slice:0; let i = index" 
             [style.display]="matchesSearch(incident) ? 'block' : 'none'"
             cdkDrag>
          <div class="drag-handle" cdkDragHandle><mat-icon>drag_indicator</mat-icon></div>
          <div class="ticket-header">
            <span class="priority-badge" 
                  [style.background-color]="getPriorityColor(incident.priority)">
              {{ getPriorityLabel(incident.priority) }}
            </span>
            <span class="ticket-id">#{{ incident.id }}</span>
          </div>
          <div class="ticket-title">{{ incident.title }}</div>
          <div class="ticket-assignee-row">
            <div class="avatar" [style.background]="getAvatarColor(incident)">{{ getAssigneeInitials(incident) }}</div>
            <div class="assignee-and-date">
              <div class="assignee-name">{{ getAssigneeName(incident) }}</div>
              <div class="created-date">Créé le {{ formatDate(incident.creationDate) }}</div>
            </div>
          </div>
        </div>
        <button class="add-card" mat-stroked-button color="primary" (click)="createTicket()"><mat-icon>add</mat-icon> Ajouter</button>
      </div>
    </div>

    <!-- Résolu -->
    <div class="kanban-column">
      <div class="column-header resolu">
        <h3>Résolu</h3>
        <span class="count">{{ getFilteredCount('resolu') }}</span>
      </div>
      <div class="column-content" 
           cdkDropList 
           id="resolu"
           [cdkDropListData]="resolu"
           [cdkDropListConnectedTo]="['backlog', 'ouvert', 'enCours', 'aValider']"
           (cdkDropListDropped)="onDrop($event)"
           (cdkDropListEntered)="onListEntered('resolu')"
           (cdkDropListExited)="onListExited('resolu')"
           [ngClass]="{ 'is-over': isOver['resolu'] }">
        <div class="ticket-card" 
             *ngFor="let incident of resolu | slice:0; let i = index" 
             [style.display]="matchesSearch(incident) ? 'block' : 'none'"
             cdkDrag>
          <div class="drag-handle" cdkDragHandle><mat-icon>drag_indicator</mat-icon></div>
          <div class="ticket-header">
            <span class="priority-badge" 
                  [style.background-color]="getPriorityColor(incident.priority)">
              {{ getPriorityLabel(incident.priority) }}
            </span>
            <span class="ticket-id">#{{ incident.id }}</span>
          </div>
          <div class="ticket-title">{{ incident.title }}</div>
          <div class="ticket-assignee-row">
            <div class="avatar" [style.background]="getAvatarColor(incident)">{{ getAssigneeInitials(incident) }}</div>
            <div class="assignee-and-date">
              <div class="assignee-name">{{ getAssigneeName(incident) }}</div>
              <div class="created-date">Créé le {{ formatDate(incident.creationDate) }}</div>
            </div>
          </div>
        </div>
        <button class="add-card" mat-stroked-button color="primary" (click)="createTicket()"><mat-icon>add</mat-icon> Ajouter</button>
      </div>
    </div>
    </div>
    
    <button class="scroll-arrow scroll-arrow-right" 
            (click)="scrollRight()" 
            [disabled]="canScrollRight"
            mat-icon-button>
      <mat-icon>chevron_right</mat-icon>
    </button>
  </div>

  <!-- Loading template -->
  <ng-template #loadingTemplate>
    <div class="loading-container">
      <mat-spinner diameter="50"></mat-spinner>
      <p>Chargement des incidents...</p>
    </div>
  </ng-template>


</div>
